<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmin/Virtualmin DevOps Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            transition: transform 0.2s ease;
        }

        .metric:hover {
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-critical { background-color: #e74c3c; }
        .status-unknown { background-color: #95a5a6; }

        .pipeline-list {
            list-style: none;
        }

        .pipeline-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            transition: background-color 0.2s ease;
        }

        .pipeline-item:hover {
            background: #e9ecef;
        }

        .pipeline-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .pipeline-status {
            float: right;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-success { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-running { background: #d1ecf1; color: #0c5460; }
        .status-pending { background: #fff3cd; color: #856404; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .logs-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-timestamp {
            color: #7f8c8d;
            margin-right: 15px;
        }

        .log-level-info { color: #3498db; }
        .log-level-warning { color: #f39c12; }
        .log-level-error { color: #e74c3c; }
        .log-level-success { color: #27ae60; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Webmin/Virtualmin DevOps Dashboard</h1>
            <p>Monitoreo y gesti√≥n completa de pipelines DevOps</p>
        </div>

        <div class="controls">
            <h3>üéõÔ∏è Controles de Pipeline</h3>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="runPipeline('unit-tests')">
                    üß™ Ejecutar Tests Unitarios
                </button>
                <button class="btn btn-primary" onclick="runPipeline('integration-tests')">
                    üîó Ejecutar Tests de Integraci√≥n
                </button>
                <button class="btn btn-success" onclick="runPipeline('deploy-staging')">
                    üì¶ Desplegar a Staging
                </button>
                <button class="btn-success" onclick="runPipeline('deploy-production')">
                    üöÄ Desplegar a Producci√≥n
                </button>
                <button class="btn btn-warning" onclick="runPipeline('rollback')">
                    üîÑ Rollback
                </button>
                <button class="btn btn-danger" onclick="runPipeline('emergency-stop')">
                    üõë Parada de Emergencia
                </button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä M√©tricas del Sistema</h3>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-value" id="cpu-usage">--</span>
                        <span class="metric-label">CPU Usage</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="memory-usage">--</span>
                        <span class="metric-label">Memory Usage</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="disk-usage">--</span>
                        <span class="metric-label">Disk Usage</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="active-pipelines">--</span>
                        <span class="metric-label">Active Pipelines</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="systemChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üîß Estado de Servicios</h3>
                <div id="services-status" class="loading">
                    <div class="spinner"></div>
                    Cargando estado de servicios...
                </div>
            </div>

            <div class="card">
                <h3>üìà Pipelines Recientes</h3>
                <ul class="pipeline-list" id="recent-pipelines">
                    <li class="loading">Cargando pipelines...</li>
                </ul>
            </div>

            <div class="card">
                <h3>üö® Alertas Activas</h3>
                <div id="active-alerts" class="loading">
                    <div class="spinner"></div>
                    Verificando alertas...
                </div>
            </div>
        </div>

        <div class="logs-section">
            <h3>üìã Logs Recientes</h3>
            <div id="recent-logs" class="loading">
                <div class="spinner"></div>
                Cargando logs...
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let systemChart;
        let updateInterval;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startAutoUpdate();
        });

        // Inicializar dashboard
        function initializeDashboard() {
            initializeCharts();
            loadInitialData();
        }

        // Inicializar gr√°ficos
        function initializeCharts() {
            const ctx = document.getElementById('systemChart').getContext('2d');
            systemChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                await Promise.all([
                    updateSystemMetrics(),
                    updateServicesStatus(),
                    updateRecentPipelines(),
                    updateActiveAlerts(),
                    updateRecentLogs()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Actualizar m√©tricas del sistema
        async function updateSystemMetrics() {
            try {
                const response = await fetch('/cgi-bin/devops-dashboard.cgi?action=get_metrics');
                const data = await response.json();

                // Actualizar m√©tricas individuales
                document.getElementById('cpu-usage').textContent = data.cpu + '%';
                document.getElementById('memory-usage').textContent = data.memory + '%';
                document.getElementById('disk-usage').textContent = data.disk + '%';
                document.getElementById('active-pipelines').textContent = data.pipelines;

                // Actualizar gr√°fico
                const now = new Date().toLocaleTimeString();
                systemChart.data.labels.push(now);
                systemChart.data.datasets[0].data.push(data.cpu);
                systemChart.data.datasets[1].data.push(data.memory);

                // Mantener solo las √∫ltimas 20 lecturas
                if (systemChart.data.labels.length > 20) {
                    systemChart.data.labels.shift();
                    systemChart.data.datasets[0].data.shift();
                    systemChart.data.datasets[1].data.shift();
                }

                systemChart.update();
            } catch (error) {
                console.error('Error updating system metrics:', error);
                // Datos de fallback
                document.getElementById('cpu-usage').textContent = '--';
                document.getElementById('memory-usage').textContent = '--';
                document.getElementById('disk-usage').textContent = '--';
                document.getElementById('active-pipelines').textContent = '--';
            }
        }

        // Actualizar estado de servicios
        async function updateServicesStatus() {
            try {
                const response = await fetch('/cgi-bin/devops-dashboard.cgi?action=get_services');
                const services = await response.json();

                const container = document.getElementById('services-status');
                container.innerHTML = '';

                services.forEach(service => {
                    const statusClass = service.status === 'running' ? 'status-healthy' :
                                      service.status === 'stopped' ? 'status-critical' : 'status-warning';

                    const serviceElement = document.createElement('div');
                    serviceElement.className = 'metric';
                    serviceElement.innerHTML = `
                        <span class="status-indicator ${statusClass}"></span>
                        <span class="metric-value">${service.name}</span>
                        <span class="metric-label">${service.status}</span>
                    `;
                    container.appendChild(serviceElement);
                });
            } catch (error) {
                console.error('Error updating services status:', error);
                document.getElementById('services-status').innerHTML =
                    '<div class="metric"><span class="metric-label">Error cargando servicios</span></div>';
            }
        }

        // Actualizar pipelines recientes
        async function updateRecentPipelines() {
            try {
                const response = await fetch('/cgi-bin/devops-dashboard.cgi?action=get_pipelines');
                const pipelines = await response.json();

                const container = document.getElementById('recent-pipelines');
                container.innerHTML = '';

                pipelines.forEach(pipeline => {
                    const statusClass = `status-${pipeline.status}`;
                    const pipelineElement = document.createElement('li');
                    pipelineElement.className = 'pipeline-item';
                    pipelineElement.innerHTML = `
                        <span class="pipeline-name">${pipeline.name}</span>
                        <span class="pipeline-status ${statusClass}">${pipeline.status.toUpperCase()}</span>
                        <br><small>${pipeline.timestamp} - ${pipeline.duration || 'En progreso'}</small>
                    `;
                    container.appendChild(pipelineElement);
                });
            } catch (error) {
                console.error('Error updating recent pipelines:', error);
                document.getElementById('recent-pipelines').innerHTML =
                    '<li class="pipeline-item">Error cargando pipelines</li>';
            }
        }

        // Actualizar alertas activas
        async function updateActiveAlerts() {
            try {
                const response = await fetch('/cgi-bin/devops-dashboard.cgi?action=get_alerts');
                const alerts = await response.json();

                const container = document.getElementById('active-alerts');
                container.innerHTML = '';

                if (alerts.length === 0) {
                    container.innerHTML = '<div class="metric"><span class="metric-label">No hay alertas activas</span></div>';
                    return;
                }

                alerts.forEach(alert => {
                    const severityClass = `status-${alert.severity}`;
                    const alertElement = document.createElement('div');
                    alertElement.className = 'metric';
                    alertElement.innerHTML = `
                        <span class="status-indicator ${severityClass}"></span>
                        <span class="metric-value">${alert.type}</span>
                        <span class="metric-label">${alert.message}</span>
                    `;
                    container.appendChild(alertElement);
                });
            } catch (error) {
                console.error('Error updating active alerts:', error);
                document.getElementById('active-alerts').innerHTML =
                    '<div class="metric"><span class="metric-label">Error cargando alertas</span></div>';
            }
        }

        // Actualizar logs recientes
        async function updateRecentLogs() {
            try {
                const response = await fetch('/cgi-bin/devops-dashboard.cgi?action=get_logs&limit=10');
                const logs = await response.json();

                const container = document.getElementById('recent-logs');
                container.innerHTML = '';

                logs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry log-level-${log.level}`;
                    logElement.innerHTML = `
                        <span class="log-timestamp">${log.timestamp}</span>
                        <strong>${log.level.toUpperCase()}</strong>: ${log.message}
                    `;
                    container.appendChild(logElement);
                });
            } catch (error) {
                console.error('Error updating recent logs:', error);
                document.getElementById('recent-logs').innerHTML =
                    '<div class="log-entry">Error cargando logs</div>';
            }
        }

        // Ejecutar pipeline
        async function runPipeline(pipelineType) {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Ejecutando...';
                button.disabled = true;

                const response = await fetch('/cgi-bin/devops-dashboard.cgi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'run_pipeline',
                        pipeline: pipelineType
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Pipeline iniciado exitosamente', 'success');
                    // Recargar datos despu√©s de un breve delay
                    setTimeout(() => {
                        updateRecentPipelines();
                        updateRecentLogs();
                    }, 2000);
                } else {
                    showNotification('Error al ejecutar pipeline: ' + result.error, 'error');
                }

            } catch (error) {
                console.error('Error running pipeline:', error);
                showNotification('Error de conexi√≥n al ejecutar pipeline', 'error');
            } finally {
                // Restaurar bot√≥n
                setTimeout(() => {
                    event.target.textContent = originalText;
                    event.target.disabled = false;
                }, 3000);
            }
        }

        // Mostrar notificaciones
        function showNotification(message, type) {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            // Estilo seg√∫n tipo
            if (type === 'success') {
                notification.style.backgroundColor = '#27ae60';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#e74c3c';
            } else {
                notification.style.backgroundColor = '#f39c12';
            }

            document.body.appendChild(notification);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        // Iniciar actualizaci√≥n autom√°tica
        function startAutoUpdate() {
            updateInterval = setInterval(() => {
                updateSystemMetrics();
                updateServicesStatus();
                updateActiveAlerts();
                updateRecentLogs();
            }, 30000); // Actualizar cada 30 segundos
        }

        // Limpiar intervalo al salir
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // CSS para notificaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>